# v1.0 2025-6-2


### 一、代码构成与模型描述
#### 1. 代码模块划分
```plaintext
代码主要由以下模块构成：
1. 导入与配置：基础库导入、全局参数配置
2. 工具函数：高斯热图生成、坐标转换等
3. 数据处理：
   - 数据增强类（DataAugmentation）：翻转、旋转、亮度调整
   - 数据集类（MultiPointDataset）：加载RGB/深度图，生成热图标签
4. 模型构建：
   - 基础模型（DFormerModel）：基于Transformer的Encoder-Decoder结构
   - 关键点检测头（HeatmapHead）：通过转置卷积上采样生成热图
   - 组合模型（DFormerMultiPoint）：融合编码器与检测头
5. 损失函数：
   - 热图损失（MSELoss/FocalLoss）
   - 坐标损失（SmoothL1Loss）
   - 联合损失（CombinedLoss）
6. 训练流程：
   - 冻结训练策略（前70轮冻结编码器）
   - 优化器（AdamW）与学习率调度器（CosineAnnealingLR）
   - 指标计算（PCK、OKS、像素准确率）
   - 可视化与模型保存
```

#### 2. 模型结构描述
```plaintext
模型整体架构：
- 主干网络：DFormer（Encoder-Decoder结构，基于Transformer，处理RGB+深度图）
- 检测头：
  1. 两层转置卷积（ConvTranspose2d）上采样，将特征图从编码器输出尺寸放大至256x256
  2. 最终通过1x1卷积生成与关键点数量相等的热图通道
  3. 软最大化（Softmax）层从热图中解码归一化坐标
```


### 二、训练细节
#### 1. 损失函数设置
| 损失类型       | 具体实现                                                                 | 权重 |
|----------------|--------------------------------------------------------------------------|------|
| 热图损失       | MSELoss（均方误差损失），对batch取平均                                    | 1.0  |
| 坐标损失       | SmoothL1Loss（平滑L1损失），在原始图像坐标下计算像素级误差                | 0.1  |
| 联合损失       | `total_loss = 热图损失 * 1.0 + 坐标损失 * 0.1`                             | -    |

#### 2. 数据增强策略
| 增强操作       | 概率/参数范围                | 作用                                                                 |
|----------------|------------------------------|----------------------------------------------------------------------|
| 水平翻转       | 概率50%                      | 增加左右对称性数据多样性                                             |
| 垂直翻转       | 概率50%                      | 增加上下对称性数据多样性                                             |
| 随机旋转       | ±15度，概率50%               | 增强旋转不变性                                                       |
| 亮度/对比度调整| 因子[0.8, 1.2]，概率50%      | 增强光照鲁棒性                                                       |


### 三、超参数表格
| 超参数名称              | 值                          | 说明                                                                 |
|-------------------------|-----------------------------|----------------------------------------------------------------------|
| 训练轮数（Epochs）      | 100                         | 总训练周期                                                           |
| 批次大小（Batch Size）  | 16                          | 每个GPU的训练批次大小                                                 |
| 编码器学习率           | 1e-5                        | 主干网络参数更新速率                                                 |
| 检测头学习率           | 5e-4                        | 检测头参数更新速率                                                   |
| 权重衰减（Weight Decay）| 1e-4                        | L2正则化强度                                                         |
| 高斯核标准差（σ）       | 3.0                         | 热图生成时的高斯模糊程度                                             |
| 冻结轮数（Freeze Epochs）| 70                          | 前70轮冻结编码器参数，仅训练检测头                                    |
| 学习率调度器           | CosineAnnealingLR，T_max=30 | 学习率呈余弦衰减，周期30轮                                           |


### 四、配置表格
| 配置项                | 值/路径示例                          | 说明                                                                 |
|-----------------------|---------------------------------------|----------------------------------------------------------------------|
| 模型配置文件          | `local_configs.NYUDepthv2.DFormerv2_L` | DFormer模型的配置参数（如输入通道、Transformer层数等）               |
| 预训练权重路径        | `checkpoints/pretrained/DFormerv2_Large_NYU.pth` | 主干网络预训练权重（在NYU Depth v2数据集上训练）              |
| 训练数据集CSV         | `my_dataset_3/train.csv`              | 训练集关键点标注文件                                                 |
| 验证数据集CSV         | `my_dataset_3/val.csv`                | 验证集关键点标注文件                                                 |
| RGB图像目录           | `my_dataset_3/rgb/`                   | 彩色图像存储路径                                                     |
| 深度图目录           | `my_dataset_3/depth/`                 | 深度图存储路径（.tiff格式）                                           |
| 输出目录              | `outputs/`                            | 模型、日志、可视化结果保存路径                                       |


### 五、指标结果（假设示例）
| 指标名称       | 训练集         | 验证集         | 说明                                                                 |
|----------------|----------------|----------------|----------------------------------------------------------------------|
| 联合损失（Loss）| 0.082          | 0.095          | 越低表示预测与标签越接近                                             |
| PCK@0.05       | 0.89（89%）    | 0.85（85%）    | 预测点与真实点归一化距离<5%的比例                                    |
| OKS            | 0.92           | 0.88           | 关键点相似度（越高表示定位越精准）                                   |
| 像素准确率     | 0.91（91%）    | 0.87（87%）    | 预测点与真实点像素距离<10的比例                                     |

**说明**：实际指标需根据具体数据集和训练效果调整，以上为假设的理想结果，用于展示指标含义。


### 六、关键流程伪代码
```python
# 训练流程伪代码
初始化模型、优化器、调度器
加载预训练权重，冻结编码器
for epoch in range(总轮数):
    if epoch == FREEZE_EPOCHS: 解冻编码器
    for batch in 训练数据:
        前向传播计算热图和坐标
        计算联合损失（热图损失+坐标损失）
        反向传播更新参数
    for batch in 验证数据:
        前向传播并计算指标（PCK/OKS）
        可视化预测结果（每5轮）
    保存最佳模型（基于PCK/损失/OKS）
```

如需进一步调整某个模块的细节，请说明具体需求！